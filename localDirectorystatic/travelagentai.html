<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI æ—…éŠåŠ©ç† Widget</title>

<style>
/* --- existing styles (kept, small additions below) --- */
body { 
  margin:0; 
  font-family: 'Segoe UI', Roboto, sans-serif; 
  background:#101010; 
  color:#fff; 
}

.chat-widget {
  position: fixed; 
  right: 20px; 
  bottom: 20px;
  z-index: 9999; 
  display:flex; 
  flex-direction:column; 
  align-items:flex-end; 
  gap:10px;
}

.chat-btn {
  background: linear-gradient(135deg, #ffcc70, #ff7eb3);
  border: none; 
  border-radius: 50px;
  padding: 14px 20px; 
  font-weight:700; 
  font-size:15px;
  cursor:pointer;
  color:#111;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  transition: transform .2s ease;
}
.chat-btn:hover { transform: scale(1.05); }

.chat-panel {
  position: fixed; 
  right: 20px; 
  bottom: 80px; 
  width: 380px; 
  max-width: 92vw;
  background: rgba(255,255,255,0.07);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-radius:18px; 
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.15);
  display:flex; 
  flex-direction:column;
  opacity:0; 
  transform:translateY(20px);
  pointer-events:none; 
  visibility:hidden;
  transition: opacity .3s ease, transform .3s ease, visibility 0s linear .3s;
}
.chat-panel.open {
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
  visibility:visible;
  transition: opacity .3s ease, transform .3s ease;
}

.chat-header { 
  padding:14px 16px; 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  background: rgba(0,0,0,0.4); 
  border-bottom:1px solid rgba(255,255,255,0.1); 
}
.brand{ font-weight:800; font-size:16px; letter-spacing:0.5px; }
.desc{ font-size:12px; color:rgba(255,255,255,0.75); }

.chat-area { 
  padding:16px; 
  display:flex; 
  flex-direction:column; 
  gap:12px; 
  min-height:220px; 
  max-height:50vh; 
  overflow-y:auto; 
  overflow-x:hidden; 
  box-sizing: border-box;
}
.bubble { 
  max-width: 90%; 
  padding:12px 14px; 
  border-radius:18px; 
  line-height:1.4; 
  font-size:14px; 
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  word-wrap: break-word; 
  overflow-wrap: break-word; 
  box-sizing: border-box;
}
.bubble.user { 
  align-self:flex-end; 
  background: linear-gradient(135deg, #a8ff78, #78ffd6);
  color:#000; 
  border-bottom-right-radius:6px; 
}
.bubble.bot { 
  align-self:flex-start; 
  background: linear-gradient(135deg, #84fab0, #8fd3f4);
  color:#000; 
  border-bottom-left-radius:6px; 
}
.typing{ font-size:13px; color:rgba(255,255,255,0.75); padding-left:6px; }

/* quick actions */
.quick-actions{ 
  display:flex; 
  gap:8px; 
  flex-wrap:wrap; 
  margin-bottom:6px; 
}
.quick-btn{ 
  background: rgba(255,255,255,0.15); 
  border:none; 
  border-radius:10px; 
  padding:8px 12px; 
  font-size:13px; 
  cursor:pointer; 
  color:#fff; 
  backdrop-filter: blur(6px);
  transition: background .2s;
}
.quick-btn:hover{ background: rgba(255,255,255,0.25); }

.chat-input-row{ 
  display:flex; 
  gap:8px; 
  padding:12px; 
  border-top:1px solid rgba(255,255,255,0.1); 
  background: rgba(0,0,0,0.3); 
}
#chatInput{ 
  flex:1; 
  min-height:42px; 
  padding:10px 12px; 
  border-radius:12px; 
  border:1px solid rgba(255,255,255,0.2); 
  background: rgba(255,255,255,0.05); 
  color:#fff; 
  outline:none; 
  resize:none; 
}
#chatInput::placeholder{ color:rgba(255,255,255,0.5); }
#sendChatBtn{ 
  padding:10px 14px; 
  border-radius:12px; 
  border:none; 
  background: linear-gradient(135deg, #ffcc70, #ff7eb3);
  color:#111; 
  font-weight:700; 
  cursor:pointer; 
  min-width:70px; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* --- additions for form bubble and recommendation cards --- */
.form-bubble { 
  background: linear-gradient(135deg, #ffffff10, #ffffff05);
  padding:12px;
  border-radius:14px;
  width: 100%;
  box-sizing: border-box;
}
.form-bubble form { display:flex; flex-direction:column; gap:8px; }
.form-bubble label { font-size:12px; color: rgba(255,255,255,0.9); }
.form-bubble input[type="text"],
.form-bubble input[type="date"],
.form-bubble input[type="number"],
.form-bubble select,
.form-bubble textarea {
  padding:8px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.03);
  color:#fff;
  outline:none;
  font-size:13px;
}
.form-row { display:flex; gap:8px; }
.form-row .half { flex:1; }

.form-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:4px; }
.btn-ghost {
  background: transparent;
  border:1px solid rgba(255,255,255,0.12);
  color:#fff;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
}
.btn-primary {
  background: linear-gradient(135deg, #ffcc70, #ff7eb3);
  border:none;
  color:#111;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}

.reco-card {
  background: rgba(0,0,0,0.35);
  padding:10px;
  border-radius:12px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  width:100%;
}
.reco-left { width:64px; height:64px; border-radius:8px; background: linear-gradient(135deg,#ffcc70,#ff7eb3); display:flex; align-items:center; justify-content:center; font-weight:800; color:#111;}
.reco-body { flex:1; }
.reco-title { font-weight:700; margin-bottom:4px; }
.reco-desc { font-size:13px; color: rgba(255,255,255,0.9); margin-bottom:6px; }
.reco-actions { display:flex; gap:8px; justify-content:flex-end; }

.small-link { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:13px; }

@media (max-width:600px){ 
  .chat-panel{ 
    right:0; 
    bottom:0; 
    width:100%; 
    max-width:100%; 
    border-radius:16px 16px 0 0; 
  }
}
</style>
</head>
<body>

<div class="chat-widget">
  <button class="chat-btn" id="chatToggle" aria-expanded="false" aria-controls="travelChatPanel">ğŸ’¬ æ—…éŠåŠ©ç†</button>

  <div class="chat-panel" id="travelChatPanel" role="dialog" aria-label="Travel Assistant" aria-modal="false">
    <div class="chat-header">
      <div>
        <div class="brand">AI æ—…éŠåŠ©ç† âœˆï¸</div>
        <div class="desc">å¯è©¢å•æ™¯é»ã€å« Uberã€è¡Œç¨‹å»ºè­°</div>
      </div>
      <div>
        <button id="closeChatPanel" style="background:none;border:none;color:#fff;cursor:pointer;font-weight:700">âœ•</button>
      </div>
    </div>
    <div class="chat-area" id="chatArea" aria-live="polite"></div>
    <div style="padding:0 12px 10px;">
      <div class="quick-actions" id="quickActions" role="toolbar" aria-label="Quick actions">
        <button class="quick-btn" data-msg="å»ºè­°æ™¯é»">å»ºè­°æ™¯é»</button>
        <button class="quick-btn" data-msg="å« Uber">å« Uber</button>
        <button class="quick-btn" data-msg="è¦åŠƒè¡Œç¨‹">è¦åŠƒè¡Œç¨‹</button>
      </div>
      <div class="chat-input-row">
        <textarea id="chatInput" placeholder="è¼¸å…¥æ‚¨çš„æ—…éŠå•é¡Œ..." aria-label="Message input"></textarea>
        <button id="sendChatBtn">å‚³é€</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ----------------- DOM refs ----------------- */
const chatToggle = document.getElementById('chatToggle');
const chatPanel = document.getElementById('travelChatPanel');
const closeChatPanel = document.getElementById('closeChatPanel');
const chatArea = document.getElementById('chatArea');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');
const quickActions = document.getElementById('quickActions');

function openChat() {
  chatPanel.classList.add('open');
  chatToggle.setAttribute('aria-expanded','true');
  chatInput.focus();
}
function closeChat() {
  chatPanel.classList.remove('open');
  chatToggle.setAttribute('aria-expanded','false');
}
chatToggle.addEventListener('click', ()=> {
  if (chatPanel.classList.contains('open')) closeChat(); else openChat();
});
closeChatPanel.addEventListener('click', closeChat);

/* ----------------- helper utilities ----------------- */
function scrollToBottom() {
  chatArea.scrollTop = chatArea.scrollHeight;
}
function createBubble(who='bot') {
  const div = document.createElement('div');
  div.className = 'bubble ' + (who==='user' ? 'user' : 'bot');
  return div;
}

/* append plain text bubble (keeps previous logic) */
function appendTextBubble(text, who='bot') {
  const div = createBubble(who);
  div.textContent = text;
  chatArea.appendChild(div);
  scrollToBottom();
  return div;
}

/* form bubble for itinerary */
function appendItineraryFormBubble() {
  // remove any existing form bubble (only one at time)
  const existing = chatArea.querySelector('.form-bubble');
  if (existing) existing.closest('.bubble').remove();

  const bubble = createBubble('bot');
  const wrapper = document.createElement('div');
  wrapper.className = 'form-bubble';
  wrapper.innerHTML = `
    <form id="itineraryForm" aria-label="è¦åŠƒè¡Œç¨‹è¡¨å–®">
      <label for="dest">ç›®çš„åœ° (ä¾‹å¦‚ï¼šå°åŒ—)</label>
      <input id="dest" name="dest" type="text" placeholder="è¼¸å…¥åŸå¸‚æˆ–æ™¯é»" required />

      <div class="form-row">
        <div class="half">
          <label for="startDate">å‡ºç™¼æ—¥æœŸ</label>
          <input id="startDate" name="startDate" type="date" />
        </div>
        <div class="half">
          <label for="days">å¤©æ•¸</label>
          <input id="days" name="days" type="number" min="1" value="2" required />
        </div>
      </div>

      <label for="style">æ—…éŠåå¥½</label>
      <select id="style" name="style">
        <option value="culture">æ–‡åŒ– / å¤è¹Ÿ</option>
        <option value="food">ç¾é£Ÿ</option>
        <option value="nature">è‡ªç„¶ / å¥è¡Œ</option>
        <option value="shopping">è³¼ç‰© / å¤œå¸‚</option>
        <option value="mixed" selected>ç¶œåˆ</option>
      </select>

      <label for="interests">é—œæ³¨é …ç›® (ä»¥é€—è™Ÿåˆ†éš”, e.g. åšç‰©é¤¨, å’–å•¡)</label>
      <input id="interests" name="interests" type="text" placeholder="åšç‰©é¤¨, å’–å•¡, å¤œå¸‚" />

      <div class="form-row" style="align-items:center">
        <div class="half">
          <label for="budget">é ç®—ç­‰ç´š</label>
          <select id="budget" name="budget">
            <option value="low">ä½</option>
            <option value="mid" selected>ä¸­</option>
            <option value="high">é«˜</option>
          </select>
        </div>
        <div class="half">
          <label for="people">äººæ•¸</label>
          <input id="people" name="people" type="number" min="1" value="2" />
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-ghost" id="itineraryCancel">å–æ¶ˆ</button>
        <button type="submit" class="btn-primary" id="itinerarySubmit">é–‹å§‹è¦åŠƒ</button>
      </div>
    </form>
  `;
  bubble.appendChild(wrapper);
  chatArea.appendChild(bubble);
  scrollToBottom();

  // focus destination input
  const destInput = wrapper.querySelector('#dest');
  destInput.focus();

  // handlers
  wrapper.querySelector('#itineraryCancel').addEventListener('click', () => {
    bubble.remove();
  });

  wrapper.querySelector('#itineraryForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target;
    const data = {
      dest: form.dest.value.trim(),
      startDate: form.startDate.value || null,
      days: Number(form.days.value) || 1,
      style: form.style.value,
      interests: form.interests.value.split(',').map(s=>s.trim()).filter(Boolean),
      budget: form.budget.value,
      people: Number(form.people.value) || 1
    };

    // basic validation
    if (!data.dest) {
      alert('è«‹è¼¸å…¥ç›®çš„åœ°ã€‚');
      form.dest.focus(); return;
    }
    // remove form bubble (we'll replace it with user summary & typing)
    bubble.remove();

    // echo user's filled form as a user bubble
    const summaryText = `è¦åŠƒè¡Œç¨‹ï¼š${data.dest}ï¼Œ${data.days} å¤©ï¼Œåå¥½ï¼š${translateStyle(data.style)}ï¼Œé—œæ³¨ï¼š${data.interests.join('ã€') || 'ç„¡'}ã€‚`;
    appendTextBubble('æ‚¨ï¼š' + summaryText, 'user');

    // show bot typing placeholder
    const typing = appendTextBubble('æ—…éŠåŠ©ç†æ­£åœ¨ç‚ºæ‚¨è¦åŠƒè¡Œç¨‹...', 'bot');
    // simulate call to recommendation engine
    setTimeout(async () => {
      typing.remove();
      const recos = generateRecommendations(data);
      appendRecommendations(recos, data);
    }, 900 + Math.random()*800);
  });
}

/* small helper to translate internal style keys to zh */
function translateStyle(key) {
  const map = { culture:'æ–‡åŒ–', food:'ç¾é£Ÿ', nature:'è‡ªç„¶', shopping:'è³¼ç‰©', mixed:'ç¶œåˆ' };
  return map[key] || key;
}

/* recommendation generation (simple heuristic - replace with real API later) */
function generateRecommendations(data) {
  // create 4 sample recommendations adapted to destination / style / interests
  const baseInterests = data.interests.length ? data.interests : ['åœ°æ¨™','æ™¯é»','åœ¨åœ°ç¾é£Ÿ','åšç‰©é¤¨'];
  const styleTag = data.style === 'mixed' ? '' : data.style;
  const n = Math.max(3, Math.min(6, data.days + 1)); // number of recs
  const recs = [];
  for (let i=0;i<n;i++){
    const interest = baseInterests[i % baseInterests.length];
    const idx = i+1;
    const title = `${data.dest} ãƒ»${capitalize(interest)} æ¨è–¦ ${idx}`;
    const shortDesc = makeDesc(data, interest, idx);
    const mapsQuery = encodeURIComponent(`${interest} near ${data.dest}`);
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${mapsQuery}`;
    recs.push({
      id: `r${Date.now()}${i}`,
      title,
      desc: shortDesc,
      mapsUrl,
      interest
    });
  }
  return recs;
}

function capitalize(s){
  if(!s) return s;
  return s[0].toUpperCase() + s.slice(1);
}

function makeDesc(data, interest, idx) {
  const budgetNote = data.budget === 'low' ? 'ï¼ˆå¹³åƒ¹ï¼‰' : data.budget === 'high' ? 'ï¼ˆé«˜ç´šï¼‰' : '';
  const peopleNote = data.people > 1 ? `é©åˆ ${data.people} äºº` : 'å–®äººäº¦å¯';
  const styleNote = data.style === 'food' ? 'åœ¨åœ°å¿…åƒå°åƒ' : (data.style === 'nature' ? 'é¢¨æ™¯èˆ‡æ­¥é“' : (data.style === 'culture' ? 'ç‰¹è‰²æ–‡åŒ–è¡Œç¨‹' : 'äººæ°£æ™¯é»'));
  return `${styleNote} â€” ${capitalize(interest)} ${idx} ${budgetNote}ï¼Œ${peopleNote}ã€‚`;
}

/* append recommendation list to chat area */
function appendRecommendations(recs, data) {
  // Title bubble
  appendTextBubble(`æ—…éŠåŠ©ç†ï¼šæ ¹æ“šæ‚¨çš„åå¥½ï¼ˆ${data.dest}ï¼Œ${data.days} å¤©ï¼Œ${translateStyle(data.style)}ï¼‰ï¼Œæˆ‘ç‚ºæ‚¨æŒ‘é¸äº† ${recs.length} å€‹æ¨è–¦ï¼š`, 'bot');

  // For each recommendation, create a card bubble
  recs.forEach(r=>{
    const bubble = createBubble('bot');
    const card = document.createElement('div');
    card.className = 'reco-card';
    card.innerHTML = `
      <div class="reco-left">${r.interest ? r.interest[0].toUpperCase() : 'â˜…'}</div>
      <div class="reco-body">
        <div class="reco-title">${r.title}</div>
        <div class="reco-desc">${r.desc}</div>
        <div class="reco-actions">
          <button class="small-link" data-maps="${r.mapsUrl}">åœ¨åœ°åœ–ä¸­æŸ¥çœ‹</button>
          <button class="small-link" data-more="${r.id}">æ›´å¤šè³‡è¨Š</button>
        </div>
      </div>
    `;
    bubble.appendChild(card);
    chatArea.appendChild(bubble);

    // click handlers for links inside card
    card.querySelector('[data-maps]').addEventListener('click', (e) => {
      const url = e.currentTarget.getAttribute('data-maps');
      // open new tab and also expand small inline iframe
      window.open(url, '_blank', 'noopener');
      // insert inline iframe below this card (toggle)
      const parentBubble = bubble;
      let iframeWrap = parentBubble.querySelector('.map-inline');
      if (iframeWrap) {
        iframeWrap.remove();
        scrollToBottom();
        return;
      }
      iframeWrap = document.createElement('div');
      iframeWrap.className = 'map-inline';
      iframeWrap.style.marginTop = '8px';
      iframeWrap.innerHTML = `<iframe width="100%" height="160" style="border:0;border-radius:10px; overflow:hidden" loading="lazy" src="${url}&output=embed"></iframe>`;
      parentBubble.appendChild(iframeWrap);
      scrollToBottom();
    });

    card.querySelector('[data-more]').addEventListener('click', (e) => {
      appendTextBubble(`æ—…éŠåŠ©ç†ï¼šæ›´å¤š ${r.title} çš„è³‡è¨Š â€” ç‡Ÿæ¥­æ™‚é–“ã€äº¤é€šèˆ‡å°æŠ€å·§ï¼šå»ºè­°ä¸Šåˆå‰å¾€ä»¥é¿é–‹äººæ½®ã€‚`, 'bot');
    });
  });

  scrollToBottom();
}

/* intercept quick actions â€” handle è¦åŠƒè¡Œç¨‹ specially */
quickActions.addEventListener('click', e => {
  const btn = e.target.closest('.quick-btn'); if(!btn) return;
  const action = btn.dataset.msg;
  if (action === 'è¦åŠƒè¡Œç¨‹') {
    appendItineraryFormBubble();
    return;
  }
  // other quick actions go through old flow
  sendUserMessage(action);
});

/* send from input area */
sendChatBtn.addEventListener('click', ()=> {
  const txt=chatInput.value.trim(); if(!txt) return;
  sendUserMessage(txt);
});
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); sendChatBtn.click();} });

/* sendUserMessage kept for other quick actions */
async function sendUserMessage(text) {
  appendTextBubble('æ‚¨ï¼š' + text, 'user');
  chatInput.value='';
  const typing = appendTextBubble('æ—…éŠåŠ©ç†æ­£åœ¨è¼¸å…¥...', 'bot');
  const reply = await mockTravelBot(text);
  typing.remove();
  appendTextBubble('æ—…éŠåŠ©ç†ï¼š' + reply, 'bot');
}

/* mock bot for non-form queries */
/* --- ğŸ“ Geolocation Integration --- */
function getUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        appendTextBubble(`ğŸ“ æ‚¨ç›®å‰çš„ä½ç½®åœ¨ï¼š${latitude.toFixed(3)}, ${longitude.toFixed(3)}ã€‚`, "bot");
        addMapBubble(latitude, longitude, "æ‚¨ç›®å‰çš„ä½ç½®");
      },
      err => {
        appendTextBubble("âŒ ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±å®šä½æ¬Šé™ã€‚", "bot");
      }
    );
  } else {
    appendTextBubble("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚", "bot");
  }
}

/* Helper to show Google Map bubble */
function addMapBubble(lat, lng, title="åœ°åœ–ä½ç½®") {
  const bubble = createBubble("bot");
  const mapDiv = document.createElement("div");
  mapDiv.style.marginTop = "8px";
  mapDiv.innerHTML = `
    <div style="font-weight:600;margin-bottom:4px;">${title}</div>
    <iframe
      width="100%"
      height="200"
      style="border:0;border-radius:10px;"
      loading="lazy"
      allowfullscreen
      src="https://www.google.com/maps?q=${lat},${lng}&z=14&output=embed">
    </iframe>
  `;
  bubble.appendChild(mapDiv);
  chatArea.appendChild(bubble);
  scrollToBottom();
}

/* --- Mock bot for non-form queries --- */
async function mockTravelBot(msg){
  await new Promise(r=>setTimeout(r,500));
  const t = msg.toLowerCase();

  // ğŸ“ location-related queries
  if (t.includes("æˆ‘åœ¨å“ª") || t.includes("find nearby") || t.includes("where am i")) {
    getUserLocation();
    return "æ­£åœ¨ç‚ºæ‚¨å®šä½ä¸­...";
  }

  if (t.includes("å»ºè­°")) return "æ‚¨å¯ä»¥åƒè§€å°åŒ—101 ğŸ™ï¸ æˆ–å£«æ—å¤œå¸‚ ğŸŒ®ã€‚";
  if (t.includes("uber")) return "å·²å¹«æ‚¨å« Uber ğŸš•ï¼Œè·é›¢æœ€è¿‘çš„è»Šè¼›ç´„ 3 åˆ†é˜åˆ°é”ã€‚";
  if (t.includes("è¡Œç¨‹")) return "è«‹ä½¿ç”¨å³æ–¹ã€Œè¦åŠƒè¡Œç¨‹ã€æŒ‰éˆ•ä¾†å¿«é€Ÿå»ºç«‹è¡Œç¨‹ã€‚";
  return "æˆ‘å¯ä»¥å»ºè­°æ™¯é»ã€å« Uberã€è¦åŠƒè¡Œç¨‹æˆ–åµæ¸¬æ‚¨çš„ä½ç½®ã€‚è©¦è©¦è¼¸å…¥ã€æˆ‘åœ¨å“ªè£¡ï¼Ÿã€çœ‹çœ‹å§ã€‚";
}


/* initial greeting */
appendTextBubble("æ—…éŠåŠ©ç†ï¼šæ‚¨å¥½ï¼æˆ‘å¯ä»¥å”åŠ©æ‚¨æŸ¥è©¢æ™¯é»ã€å« Uber æˆ–è¦åŠƒè¡Œç¨‹ã€‚è©¦è©¦é»é¸ã€Œè¦åŠƒè¡Œç¨‹ã€ã€‚", 'bot');

</script>

</body>
</html>
